# 環境構築手順書

## 目次
1. [前提条件](#前提条件)
2. [ステップ1: プロジェクトディレクトリ作成](#ステップ1-プロジェクトディレクトリ作成)
3. [ステップ2: Backend（Rails）のセットアップ](#ステップ2-backendrailsのセットアップ)
4. [ステップ3: Frontend（React）のセットアップ](#ステップ3-frontendreactのセットアップ)
5. [ステップ4: Docker Composeの設定](#ステップ4-docker-composeの設定)
6. [ステップ5: README.mdの作成](#ステップ5-readmemdの作成)
7. [ステップ6: ビルドと起動](#ステップ6-ビルドと起動)
8. [動作確認](#動作確認)
9. [よく使うコマンド](#よく使うコマンド)

---

## 前提条件

以下がインストールされていること：
- Docker
- Docker Compose

---

## ステップ1: プロジェクトディレクトリ作成

```bash
# プロジェクトルートを作成
mkdir kaikai_app
cd kaikai_app

# backend と frontend ディレクトリを作成
mkdir backend frontend
```

---

## ステップ2: Backend（Rails）のセットアップ

### 2-1. Dockerfile.dev を作成

`backend/Dockerfile.dev` を作成し、以下を記述：

```dockerfile
# Rails API用のDockerfile（開発環境・DBなし）
FROM ruby:3.3.6

# 環境設定
ENV LANG=C.UTF-8
ENV TZ=Asia/Tokyo
ENV RAILS_ENV=development

# 必要なパッケージのインストール（API専用のため軽量化）
RUN apt-get update -qq && \
    apt-get install -y build-essential vim curl && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# 作業ディレクトリの設定
WORKDIR /app

# Bundlerのインストール
RUN gem install bundler

# GemfileとGemfile.lockをコピー（キャッシュ活用）
COPY Gemfile* ./

# Gemのインストール（Gemfileがある場合）
RUN if [ -f Gemfile ]; then bundle install; fi

# アプリケーションのソースコードをコピー
COPY . .

# ポート3000を公開
EXPOSE 3000

# Railsサーバー起動
CMD ["rails", "server", "-b", "0.0.0.0"]
```

### 2-2. .dockerignore を作成

`backend/.dockerignore` を作成し、以下を記述：

```
# Git
.git
.gitignore

# ログファイル
log/*
tmp/*

# 環境変数
.env
.env.local

# テストカバレッジ
coverage/

# エディタ設定
.vscode/
.idea/
*.swp
*.swo

# macOS
.DS_Store

# Ruby/Bundler
.bundle/
vendor/bundle
```

### 2-3. Railsプロジェクトを初期化

```bash
# Dockerコンテナを使ってRailsプロジェクト作成
docker run --rm -v "$(pwd)/backend:/app" -w /app ruby:3.3.6 \
  bash -c "gem install rails && rails new . --api --skip-bundle --skip-git --skip-test --database=sqlite3"
```

**注意**: 途中で `.dockerignore` を上書きするか聞かれたら `Y` を入力

### 2-4. Gemfileを修正

Rails 8.1はまだリリースされていないため、Gemfileを修正します：

`backend/Gemfile` の4行目を以下のように修正：

```ruby
# 修正前
gem "rails", "~> 8.1.0"

# 修正後
gem "rails", "~> 8.0.0"
```

また、CORS対応のため、rack-corsのコメントアウトを解除：

```ruby
# 修正前
# gem "rack-cors"

# 修正後
gem "rack-cors"
```

さらに、image_processing（API mode では不要）を削除：

```ruby
# 以下の行を削除
gem "image_processing", "~> 1.2"
```

### 2-5. config/application.rbを修正

`backend/config/application.rb` の24行目を修正：

```ruby
# 修正前
config.load_defaults 8.1

# 修正後
config.load_defaults 8.0
```

---

## ステップ3: Frontend（React）のセットアップ

### 3-1. Dockerfile.dev を作成

`frontend/Dockerfile.dev` を作成し、以下を記述：

```dockerfile
# React用のDockerfile（開発環境）
FROM node:20-alpine

# 作業ディレクトリの設定
WORKDIR /app

# package.jsonとpackage-lock.jsonをコピー（キャッシュ活用）
COPY package*.json ./

# 依存関係のインストール
RUN npm install

# アプリケーションのソースコードをコピー
COPY . .

# ポート5173を公開（Vite開発サーバー用）
EXPOSE 5173

# 開発サーバー起動
CMD ["npm", "run", "dev", "--", "--host", "0.0.0.0"]
```

### 3-2. .dockerignore を作成

`frontend/.dockerignore` を作成し、以下を記述：

```
# Git
.git
.gitignore

# Node modules
node_modules/

# ビルド成果物
dist/
build/

# ログファイル
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# 環境変数
.env
.env.local
.env.development.local
.env.test.local
.env.production.local

# テストカバレッジ
coverage/

# エディタ設定
.vscode/
.idea/
*.swp
*.swo

# macOS
.DS_Store

# キャッシュ
.cache/
```

### 3-3. 必要なパッケージをインストール

```bash
# package.json を初期化
docker run --rm -v "$(pwd)/frontend:/app" -w /app node:20-alpine \
  sh -c "npm init -y && npm install --save-dev vite @vitejs/plugin-react typescript @types/react @types/react-dom"

# React と React DOM をインストール
docker run --rm -v "$(pwd)/frontend:/app" -w /app node:20-alpine \
  sh -c "npm install react react-dom"

# TailwindCSS v4 をインストール
docker run --rm -v "$(pwd)/frontend:/app" -w /app node:20-alpine \
  sh -c "npm install --save-dev tailwindcss @tailwindcss/postcss postcss autoprefixer"
```

### 3-4. package.json を編集

`frontend/package.json` を以下のように編集：

```json
{
  "name": "kaikai-frontend",
  "version": "0.1.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "react": "^19.1.1",
    "react-dom": "^19.1.1"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4.1.15",
    "@types/react": "^19.2.2",
    "@types/react-dom": "^19.2.2",
    "@vitejs/plugin-react": "^5.0.4",
    "autoprefixer": "^10.4.21",
    "postcss": "^8.5.6",
    "tailwindcss": "^4.1.15",
    "typescript": "^5.9.3",
    "vite": "^7.1.11"
  }
}
```

### 3-5. Vite設定ファイルを作成

`frontend/vite.config.ts` を作成：

```typescript
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()],
  server: {
    host: '0.0.0.0',
    port: 5173,
  },
})
```

### 3-6. TypeScript設定ファイルを作成

`frontend/tsconfig.json` を作成：

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,

    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "isolatedModules": true,
    "moduleDetection": "force",
    "noEmit": true,
    "jsx": "react-jsx",

    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["src"]
}
```

### 3-7. TailwindCSS設定ファイルを作成

`frontend/tailwind.config.js` を作成：

```javascript
/** @type {import('tailwindcss').Config} */
export default {
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {
      colors: {
        'kai-indigo': '#4B5563',    // 界藍
        'kai-lavender': '#A5B4FC',  // 淡藤
        'kai-white': '#F9FAFB',     // 白磁
      },
      fontFamily: {
        'noto': ['"Noto Sans JP"', 'sans-serif'],
        'raleway': ['Raleway', 'sans-serif'],
      },
    },
  },
  plugins: [],
}
```

`frontend/postcss.config.js` を作成：

```javascript
export default {
  plugins: {
    '@tailwindcss/postcss': {},
    autoprefixer: {},
  },
}
```

### 3-8. Reactアプリケーションファイルを作成

ディレクトリ作成：
```bash
mkdir -p frontend/src frontend/public
```

`frontend/index.html` を作成：

```html
<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>界回（KAIKAI）</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
```

`frontend/src/main.tsx` を作成：

```typescript
import React from 'react'
import ReactDOM from 'react-dom/client'
import App from './App'
import './index.css'

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>,
)
```

`frontend/src/App.tsx` を作成：

```typescript
import { useState } from 'react'

function App() {
  return (
    <div style={{ padding: '2rem', fontFamily: 'system-ui' }}>
      <h1>界回（KAIKAI）</h1>
      <p>あなたのシフトに、旅のリズムを。</p>
      <p style={{ color: '#666', marginTop: '1rem' }}>
        セットアップ完了！Vite + React + TypeScript が動作しています。
      </p>
    </div>
  )
}

export default App
```

`frontend/src/index.css` を作成：

```css
@import "tailwindcss";
```

`frontend/src/vite-env.d.ts` を作成（TypeScript用型定義）：

```typescript
/// <reference types="vite/client" />

declare module '*.css' {
  const content: Record<string, string>
  export default content
}
```

---

## ステップ4: Docker Composeの設定

プロジェクトルートに `docker-compose.yml` を作成：

```yaml
services:
  # Rails APIサーバー
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    container_name: kaikai_backend
    ports:
      - "3000:3000"
    volumes:
      - ./backend:/app
      - bundle_cache:/usr/local/bundle
    environment:
      - RAILS_ENV=development
    command: bash -c "rm -f tmp/pids/server.pid && rails server -b 0.0.0.0"
    stdin_open: true
    tty: true

  # React フロントエンド
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    container_name: kaikai_frontend
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/app
      - node_modules:/app/node_modules
    environment:
      - VITE_API_URL=http://localhost:3000
    depends_on:
      - backend
    stdin_open: true
    tty: true

volumes:
  bundle_cache:
  node_modules:
```

---

## ステップ5: README.mdの作成

プロジェクトルートに `README.md` を作成：

```markdown
# 界回（KAIKAI）

> あなたのシフトに、旅のリズムを。
> 働く"回"の中に、"界"の癒しを。

---

## 🧭 概要

看護師の勤務サイクルと星野リゾート「界タビ20s」プランを掛け合わせ、**「今のシフト周期で予約できる日」を自動で算出する**アプリケーションです。

### コンセプト

- **シフトサイクル × 旅プランの予約可能日抽出**
- 看護師の4週間シフトサイクルに最適化
- 界タビ20s（20代限定・平日・44日前予約開始）のルールに準拠

---

## 🏗️ 技術スタック

| レイヤー | 技術 |
|---------|------|
| **Backend** | Ruby 3.3.6 + Rails 8.0.3 (API mode, DBなし) |
| **Frontend** | React 19 + TypeScript 5.9 + Vite 7.1 + TailwindCSS 4.1 |
| **Infrastructure** | Docker + Docker Compose |

### 特徴

- ✨ データベース不要の軽量構成
- 🎯 日付計算のみに特化したMVP
- 🐳 Docker環境で簡単セットアップ

---

## ✨ 実装範囲（MVP段階）

| 区分 | 機能名 | 内容 |
|------|--------|------|
| 🗓️ | 入力フォーム | Aシフト／Bシフト発表日を入力 |
| 🧮 | API | `/api/v1/reservable_dates` で日付演算を実行 |
| 📋 | 結果表示 | Railsで算出した「予約可能日」をリスト表示 |
| ⚠️ | バリデーション | 不正入力・逆転日付のチェック |
| ⏳ | ローディング | 計算中のスピナー or テキスト表示 |
| 💬 | 補足文 | 界タビ20sルール（20代・平日・44日前）を明記 |

---

## ⚙️ API仕様

### エンドポイント

\```
POST /api/v1/reservable_dates
Content-Type: application/json
\```

### リクエスト例

\```json
{
  "a_shift_date": "2025-10-17",
  "b_shift_date": "2025-11-14"
}
\```

### レスポンス例（成功）

\```json
{
  "reservable_dates": [
    "2025-11-06",
    "2025-11-07",
    "2025-11-10",
    "2025-11-11"
  ]
}
\```

### レスポンス例（エラー）

\```json
{
  "error": "Invalid date range or missing parameters"
}
\```

### 判定ルール

1. **シフト期間内**: Aシフト ≦ 対象日 ＜ Bシフト
2. **平日のみ**: 月曜日〜木曜日
3. **予約可能日**: 現在から44日以降
4. **検索上限**: 60日以内

---

## 🎨 UI概要（MVP）

\```
───────────────────────────────
界回（KAIKAI）
───────────────────────────────
あなたのシフトに、旅のリズムを。

Aシフト発表日： [2025-10-17]
Bシフト発表日： [2025-11-14]

[ 🔍 予約可能日を表示 ]

───────────────────────────────
✅ 2025-11-06（木）
✅ 2025-11-10（月）
✅ 2025-11-11（火）

ℹ️ 「界タビ20s」：20代限定・平日・44日前予約開始
───────────────────────────────
界回 © 2025
───────────────────────────────
\```

---

## 🎨 デザイン指針

### カラーパレット

| 色名 | カラーコード | 用途 |
|------|-------------|------|
| **界藍** | `#4B5563` | メインカラー |
| **淡藤** | `#A5B4FC` | アクセント |
| **白磁** | `#F9FAFB` | ベース |

### フォント

- **和文**: Noto Sans JP
- **英文**: Raleway

### UIテーマ

- 和の静けさ × 医療の清潔感
- 余白を生かした静かなミニマルデザイン

---

## 🧩 状態フロー（React）

\```
[初期] → [入力] → [ロード中] → [結果表示]
                          ↓
                       [エラー表示]
\```

---

## 🚀 セットアップ

### 前提条件

- Docker
- Docker Compose

### 起動手順

\```bash
# リポジトリをクローン
git clone <repository-url>
cd kaikai_app

# Dockerイメージをビルド
docker compose build

# コンテナを起動
docker compose up -d

# ログを確認
docker compose logs -f
\```

### アクセス先

- **Frontend**: http://localhost:5173
- **Backend API**: http://localhost:3000

### よく使うコマンド

\```bash
# コンテナを停止
docker compose down

# コンテナを再起動
docker compose restart

# コンテナの状態確認
docker compose ps
\```

---

## 📁 ディレクトリ構成

\```
kaikai_app/
├── backend/              # Rails API
│   ├── app/
│   │   └── controllers/
│   ├── config/
│   ├── Gemfile
│   └── Dockerfile.dev
│
├── frontend/             # React + TypeScript
│   ├── src/
│   │   ├── App.tsx
│   │   ├── main.tsx
│   │   └── index.css
│   ├── package.json
│   ├── vite.config.ts
│   ├── tsconfig.json
│   └── Dockerfile.dev
│
├── docker-compose.yml
├── README.md
├── 環境構築メモ.md
└── 環境構築メモ_最小構成版.md
\```

---

## 🧱 今後の拡張予定（v2以降）

| 機能 | 概要 |
|------|------|
| 界プランAPI連携 | 対象施設・料金・空室情報を表示 |
| シフト自動取得 | Googleカレンダー連携 |
| 祝日除外機能 | 日本の祝日カレンダー適用 |
| 予約通知 | 44日前0時の予約可能通知 |
| カスタム周期設定 | 4週 → 任意周期化 |

---

## 📝 開発環境詳細

詳細な環境構築手順は以下を参照してください：

- **標準版**: [環境構築メモ.md](./環境構築メモ.md)
- **最小構成版**: [環境構築メモ_最小構成版.md](./環境構築メモ_最小構成版.md)

---

## 📄 ライセンス

界回（KAIKAI） © 2025

---

## 🙏 謝辞

星野リゾート「界タビ20s」プランにインスピレーションを受けて開発しました。
```

---

## ステップ6: ビルドと起動

```bash
# Dockerイメージをビルド
docker compose build

# コンテナを起動（バックグラウンド）
docker compose up -d

# ログを確認
docker compose logs -f
```

---

## 動作確認

1. **Frontend**: ブラウザで http://localhost:5173 にアクセス
   - 「界回（KAIKAI）」と表示されればOK

2. **Backend**: ブラウザで http://localhost:3000 にアクセス
   - Railsのエラーページが表示されればOK（ルートが未定義のため）

3. **コンテナ状態確認**:
```bash
docker compose ps
# 両方とも "Up" になっていればOK
```

---

## よく使うコマンド

### コンテナ管理
```bash
# コンテナを起動
docker compose up -d

# コンテナを停止
docker compose down

# コンテナを再起動
docker compose restart

# コンテナの状態確認
docker compose ps

# ログをリアルタイム表示
docker compose logs -f

# 特定サービスのログのみ表示
docker compose logs -f backend
docker compose logs -f frontend
```

### コンテナ内に入る
```bash
# Railsコンテナに入る
docker compose exec backend bash

# Reactコンテナに入る
docker compose exec frontend sh
```

### Backend（Rails）操作
```bash
# Railsコンソール起動
docker compose exec backend rails console

# ルーティング確認
docker compose exec backend rails routes

# Gemを追加した後
docker compose exec backend bundle install
docker compose restart backend
```

### Frontend（React）操作
```bash
# パッケージを追加した後
docker compose exec frontend npm install
docker compose restart frontend

# ビルド
docker compose exec frontend npm run build
```

### トラブルシューティング
```bash
# 全コンテナとボリュームを削除して再構築
docker compose down -v
docker compose build --no-cache
docker compose up -d

# イメージを完全に削除して再作成
docker compose down --rmi all -v
docker compose build
docker compose up -d
```

---

## 技術スタック

- **Backend**: Ruby 3.3.6 + Rails 8.0.3 (API mode, DBなし)
- **Frontend**: React 19 + TypeScript 5.9 + Vite 7.1 + TailwindCSS 4.1
- **Infrastructure**: Docker + Docker Compose

---

## カスタム設定

### カラーパレット
- **界藍**: `#4B5563` - メインカラー
- **淡藤**: `#A5B4FC` - アクセント
- **白磁**: `#F9FAFB` - ベース

### フォント
- **和文**: Noto Sans JP
- **英文**: Raleway

### アクセス先
- **Frontend**: http://localhost:5173
- **Backend API**: http://localhost:3000

---

## ディレクトリ構成（完成形）

```
kaikai_app/
├── backend/
│   ├── app/
│   │   ├── controllers/
│   │   ├── models/
│   │   └── ...
│   ├── config/
│   ├── Gemfile
│   ├── Dockerfile.dev
│   └── .dockerignore
│
├── frontend/
│   ├── src/
│   │   ├── App.tsx
│   │   ├── main.tsx
│   │   └── index.css
│   ├── public/
│   ├── index.html
│   ├── package.json
│   ├── vite.config.ts
│   ├── tsconfig.json
│   ├── tailwind.config.js
│   ├── postcss.config.js
│   ├── Dockerfile.dev
│   └── .dockerignore
│
├── docker-compose.yml
├── README.md
└── 環境構築メモ.md
```

---

## 次のステップ

環境構築が完了したら、以下の機能実装に進めます：

1. **APIエンドポイント実装** (`/api/v1/reservable_dates`)
2. **日付演算ロジック** (シフトサイクル計算)
3. **フロントエンドUI** (入力フォーム＋結果表示)

---

## よくあるエラーと対処法

### エラー: `package.json` が見つからない
**原因**: Reactプロジェクトのセットアップが未完了
**対処**: ステップ3を最初からやり直す

### エラー: ポートが既に使用されている
**原因**: 別のプロセスがポート3000または5173を使用中
**対処**:
```bash
# ポート使用状況を確認（Windows）
netstat -ano | findstr :3000
netstat -ano | findstr :5173

# プロセスを終了するか、docker-compose.ymlのポート番号を変更
```

### エラー: Railsが起動しない
**原因**: `tmp/pids/server.pid` が残っている
**対処**: `docker compose down` してから再起動

### フロントエンドで変更が反映されない
**原因**: ホットリロードが動作していない
**対処**:
```bash
docker compose restart frontend
```

### エラー: 500 Internal Server Error（Tailwind CSS関連）
**原因**: Tailwind CSS v4の設定が正しくない
**対処**:
```bash
# 1. @tailwindcss/postcssをインストール
npm install -D @tailwindcss/postcss

# 2. postcss.config.jsを確認（'@tailwindcss/postcss'を使用）
# 3. index.cssを確認（@import "tailwindcss"を使用）
# 4. vite-env.d.tsが存在するか確認

# 依存関係の問題がある場合は再インストール
rm -rf node_modules package-lock.json
npm install
```

### エラー: Rails 8.1のバージョンエラー
**原因**: Rails 8.1がまだリリースされていない
**症状**: `Unknown version "8.1"` というエラーメッセージ
**対処**:
```bash
# 1. backend/Gemfileを修正
# gem "rails", "~> 8.0.0" に変更

# 2. backend/config/application.rbを修正
# config.load_defaults 8.0 に変更

# 3. Dockerイメージを再ビルド
docker compose down -v
docker compose build --no-cache backend
docker compose up -d
```

### エラー: Could not find gem 'rack-cors'
**原因**: Gemfile.lockとDockerイメージのキャッシュの不整合
**対処**:
```bash
# ボリュームを含めて完全に削除して再構築
docker compose down -v
docker compose build --no-cache
docker compose up -d
```

---

## 重要な注意事項

### Rails 8.1について
現時点（2025年10月時点）では、Rails 8.1はまだリリースされていません。`rails new`コマンドで生成されるファイルには8.1の記述がありますが、以下の2ファイルを必ず修正してください：

1. `backend/Gemfile`: `gem "rails", "~> 8.0.0"`
2. `backend/config/application.rb`: `config.load_defaults 8.0`

### Tailwind CSS v4について
Tailwind CSS v4では設定方法が大きく変わりました。以下の点に注意してください：

1. **必須パッケージ**: `@tailwindcss/postcss`が必要
2. **PostCSS設定**: `'@tailwindcss/postcss'`を使用（文字列で指定）
3. **CSS記述**: `@import "tailwindcss";`（`@tailwind`ディレクティブは使用しない）
4. **型定義**: `vite-env.d.ts`でCSSモジュールの型を宣言

### Dockerキャッシュについて
Gemfileやpackage.jsonを変更した後は、キャッシュが原因でエラーが発生することがあります。その場合は以下のコマンドで完全に再構築してください：

```bash
docker compose down -v
docker compose build --no-cache
docker compose up -d
```
