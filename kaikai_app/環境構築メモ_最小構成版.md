# 環境構築手順書（最小構成版）

## 概要

本手順書は「界回（KAIKAI）」アプリのMVP版に最適化された環境構築手順です。
**データベース不要・日付計算のみ**の要件に合わせ、不要な依存関係を最初から含めない軽量構成です。

### 標準構成から除外した機能（最初から含まれていません）
- ❌ SQLite3（データベース不要 - `--skip-active-record`で除外）
- ❌ Active Storage（画像アップロード不要 - `--skip-active-storage`で除外）
- ❌ Solid系（Cache/Queue/Cable - DB依存機能・Gemfileから除外）
- ❌ Action Mailer関連（メール送信不要 - `--api`モードで除外）

---

## 目次
1. [前提条件](#前提条件)
2. [ステップ1: プロジェクトディレクトリ作成](#ステップ1-プロジェクトディレクトリ作成)
3. [ステップ2: Backend（Rails）のセットアップ](#ステップ2-backendrailsのセットアップ)
4. [ステップ3: Frontend（React）のセットアップ](#ステップ3-frontendreactのセットアップ)
5. [ステップ4: Docker Composeの設定](#ステップ4-docker-composeの設定)
6. [ステップ5: README.mdの作成](#ステップ5-readmemdの作成)
7. [ステップ6: ビルドと起動](#ステップ6-ビルドと起動)
8. [動作確認](#動作確認)
9. [よく使うコマンド](#よく使うコマンド)

---

## 前提条件

以下がインストールされていること：
- Docker
- Docker Compose

---

## ステップ1: プロジェクトディレクトリ作成

```bash
# プロジェクトルートを作成
mkdir kaikai_app
cd kaikai_app

# backend と frontend ディレクトリを作成
mkdir backend frontend
```

---

## ステップ2: Backend（Rails）のセットアップ

### 2-1. Dockerfile.dev を作成

`backend/Dockerfile.dev` を作成し、以下を記述：

```dockerfile
# Rails API用のDockerfile（開発環境・DBなし・最小構成）
FROM ruby:3.3.6

# 環境設定
ENV LANG=C.UTF-8
ENV TZ=Asia/Tokyo
ENV RAILS_ENV=development

# 必要なパッケージのインストール（API専用のため軽量化）
RUN apt-get update -qq && \
    apt-get install -y build-essential vim curl && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# 作業ディレクトリの設定
WORKDIR /app

# Bundlerのインストール
RUN gem install bundler

# GemfileとGemfile.lockをコピー（キャッシュ活用）
COPY Gemfile* ./

# Gemのインストール（Gemfileがある場合）
RUN if [ -f Gemfile ]; then bundle install; fi

# アプリケーションのソースコードをコピー
COPY . .

# ポート3000を公開
EXPOSE 3000

# Railsサーバー起動
CMD ["rails", "server", "-b", "0.0.0.0"]
```

### 2-2. .dockerignore を作成

`backend/.dockerignore` を作成し、以下を記述：

```
# Git
.git
.gitignore

# ログファイル
log/*
tmp/*

# 環境変数
.env
.env.local

# テストカバレッジ
coverage/

# エディタ設定
.vscode/
.idea/
*.swp
*.swo

# macOS
.DS_Store

# Ruby/Bundler
.bundle/
vendor/bundle
```

### 2-3. Railsプロジェクトを初期化

```bash
# Dockerコンテナを使ってRailsプロジェクト作成
docker run --rm -v "$(pwd)/backend:/app" -w /app ruby:3.3.6 \
  bash -c "gem install rails && rails new . --api --skip-bundle --skip-git --skip-test --skip-active-storage --skip-active-record"
```

**重要**: 途中で `.dockerignore` を上書きするか聞かれたら `Y` を入力

**注意**: `--skip-active-record` オプションでデータベース関連を完全にスキップします

### 2-4. Gemfileを修正（最小構成 + デプロイ・セキュリティツール）

Rails 8.1はまだリリースされていないため、Gemfileを修正します：

`backend/Gemfile` を以下のように修正：

```ruby
source "https://rubygems.org"

# Bundle edge Rails instead: gem "rails", github: "rails/rails", branch: "main"
gem "rails", "~> 8.0.0"
# Use the Puma web server [https://github.com/puma/puma]
gem "puma", ">= 5.0"

# Windows does not include zoneinfo files, so bundle the tzinfo-data gem
gem "tzinfo-data", platforms: %i[ windows jruby ]

# Reduces boot times through caching; required in config/boot.rb
gem "bootsnap", require: false

# Use Rack CORS for handling Cross-Origin Resource Sharing (CORS), making cross-origin Ajax possible
gem "rack-cors"

# Deploy this application anywhere as a Docker container [https://kamal-deploy.org]
gem "kamal", require: false

# Add HTTP asset caching/compression and X-Sendfile acceleration to Puma [https://github.com/basecamp/thruster/]
gem "thruster", require: false

group :development, :test do
  # See https://guides.rubyonrails.org/debugging_rails_applications.html#debugging-with-the-debug-gem
  gem "debug", platforms: %i[ mri windows ], require: "debug/prelude"

  # Audits gems for known security defects (use config/bundler-audit.yml to ignore issues)
  gem "bundler-audit", require: false

  # Static analysis for security vulnerabilities [https://brakemanscanner.org/]
  gem "brakeman", require: false

  # Omakase Ruby styling [https://github.com/rails/rubocop-rails-omakase/]
  gem "rubocop-rails-omakase", require: false
end
```

**最小構成から削除したgem:**
- `sqlite3` - データベース不要
- `solid_cache`, `solid_queue`, `solid_cable` - DB依存機能

**最小構成から追加したgem（本番環境・品質向上のため）:**
- `kamal` - Dockerデプロイツール（本番環境用）
- `thruster` - HTTPキャッシング・圧縮（本番環境用）
- `bundler-audit` - gemの既知の脆弱性チェック
- `brakeman` - セキュリティ静的解析
- `rubocop-rails-omakase` - Rubyコーディングスタイルチェック

### 2-5. config/application.rbを修正

`backend/config/application.rb` を開き、以下を修正：

```ruby
# 24行目あたり
# 修正前
config.load_defaults 8.1

# 修正後
config.load_defaults 8.0
```

また、Active Recordの記述を削除（既に`--skip-active-record`で生成されていない場合がある）：

```ruby
# 削除（存在する場合）
require "active_record/railtie"
```

### 2-6. config/initializers/cors.rb を有効化

`backend/config/initializers/cors.rb` のコメントを解除して、CORS設定を有効化：

```ruby
Rails.application.config.middleware.insert_before 0, Rack::Cors do
  allow do
    origins "http://localhost:5173"

    resource "*",
      headers: :any,
      methods: [:get, :post, :put, :patch, :delete, :options, :head]
  end
end
```

### 2-7. 不要なディレクトリ・ファイルを削除

```bash
cd backend

# Active Storage関連を削除
rm -rf storage/
rm -f config/storage.yml

# database.ymlを削除（データベース不要）
rm -f config/database.yml
```

---

## ステップ3: Frontend（React）のセットアップ

**※ この部分は元の環境構築メモと同じです**

### 3-1. Dockerfile.dev を作成

`frontend/Dockerfile.dev` を作成し、以下を記述：

```dockerfile
# React用のDockerfile（開発環境）
FROM node:20-alpine

# 作業ディレクトリの設定
WORKDIR /app

# package.jsonとpackage-lock.jsonをコピー（キャッシュ活用）
COPY package*.json ./

# 依存関係のインストール
RUN npm install

# アプリケーションのソースコードをコピー
COPY . .

# ポート5173を公開（Vite開発サーバー用）
EXPOSE 5173

# 開発サーバー起動
CMD ["npm", "run", "dev", "--", "--host", "0.0.0.0"]
```

### 3-2. .dockerignore を作成

`frontend/.dockerignore` を作成し、以下を記述：

```
# Git
.git
.gitignore

# Node modules
node_modules/

# ビルド成果物
dist/
build/

# ログファイル
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# 環境変数
.env
.env.local
.env.development.local
.env.test.local
.env.production.local

# テストカバレッジ
coverage/

# エディタ設定
.vscode/
.idea/
*.swp
*.swo

# macOS
.DS_Store

# キャッシュ
.cache/
```

### 3-3. 必要なパッケージをインストール

```bash
# package.json を初期化
docker run --rm -v "$(pwd)/frontend:/app" -w /app node:20-alpine \
  sh -c "npm init -y && npm install --save-dev vite @vitejs/plugin-react typescript @types/react @types/react-dom"

# React と React DOM をインストール
docker run --rm -v "$(pwd)/frontend:/app" -w /app node:20-alpine \
  sh -c "npm install react react-dom"

# TailwindCSS v4 をインストール
docker run --rm -v "$(pwd)/frontend:/app" -w /app node:20-alpine \
  sh -c "npm install --save-dev tailwindcss @tailwindcss/postcss postcss autoprefixer"
```

### 3-4. package.json を編集

`frontend/package.json` を以下のように編集：

```json
{
  "name": "kaikai-frontend",
  "version": "0.1.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "react": "^19.1.1",
    "react-dom": "^19.1.1"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4.1.15",
    "@types/react": "^19.2.2",
    "@types/react-dom": "^19.2.2",
    "@vitejs/plugin-react": "^5.0.4",
    "autoprefixer": "^10.4.21",
    "postcss": "^8.5.6",
    "tailwindcss": "^4.1.15",
    "typescript": "^5.9.3",
    "vite": "^7.1.11"
  }
}
```

### 3-5. Vite設定ファイルを作成

`frontend/vite.config.ts` を作成：

```typescript
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()],
  server: {
    host: '0.0.0.0',
    port: 5173,
  },
})
```

### 3-6. TypeScript設定ファイルを作成

`frontend/tsconfig.json` を作成：

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,

    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "isolatedModules": true,
    "moduleDetection": "force",
    "noEmit": true,
    "jsx": "react-jsx",

    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["src"]
}
```

### 3-7. TailwindCSS設定ファイルを作成

`frontend/tailwind.config.js` を作成：

```javascript
/** @type {import('tailwindcss').Config} */
export default {
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {
      colors: {
        'kai-indigo': '#4B5563',    // 界藍
        'kai-lavender': '#A5B4FC',  // 淡藤
        'kai-white': '#F9FAFB',     // 白磁
      },
      fontFamily: {
        'noto': ['"Noto Sans JP"', 'sans-serif'],
        'raleway': ['Raleway', 'sans-serif'],
      },
    },
  },
  plugins: [],
}
```

`frontend/postcss.config.js` を作成：

```javascript
export default {
  plugins: {
    '@tailwindcss/postcss': {},
    autoprefixer: {},
  },
}
```

### 3-8. Reactアプリケーションファイルを作成

ディレクトリ作成：
```bash
mkdir -p frontend/src frontend/public
```

`frontend/index.html` を作成：

```html
<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>界回（KAIKAI）</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
```

`frontend/src/main.tsx` を作成：

```typescript
import React from 'react'
import ReactDOM from 'react-dom/client'
import App from './App'
import './index.css'

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>,
)
```

`frontend/src/App.tsx` を作成：

```typescript
import { useState } from 'react'

function App() {
  return (
    <div style={{ padding: '2rem', fontFamily: 'system-ui' }}>
      <h1>界回（KAIKAI）</h1>
      <p>あなたのシフトに、旅のリズムを。</p>
      <p style={{ color: '#666', marginTop: '1rem' }}>
        セットアップ完了！Vite + React + TypeScript が動作しています。
      </p>
    </div>
  )
}

export default App
```

`frontend/src/index.css` を作成：

```css
@import "tailwindcss";
```

`frontend/src/vite-env.d.ts` を作成（TypeScript用型定義）：

```typescript
/// <reference types="vite/client" />

declare module '*.css' {
  const content: Record<string, string>
  export default content
}
```

---

## ステップ4: Docker Composeの設定

プロジェクトルートに `docker-compose.yml` を作成：

```yaml
services:
  # Rails APIサーバー（DB不要・最小構成）
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    container_name: kaikai_backend
    ports:
      - "3000:3000"
    volumes:
      - ./backend:/app
      - bundle_cache:/usr/local/bundle
    environment:
      - RAILS_ENV=development
    command: bash -c "rm -f tmp/pids/server.pid && rails server -b 0.0.0.0"
    stdin_open: true
    tty: true

  # React フロントエンド
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    container_name: kaikai_frontend
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/app
      - node_modules:/app/node_modules
    environment:
      - VITE_API_URL=http://localhost:3000
    depends_on:
      - backend
    stdin_open: true
    tty: true

volumes:
  bundle_cache:
  node_modules:
```

---

## ステップ5: README.mdの作成

**※ README.mdの内容は標準版と同じです。**

プロジェクトルートに `README.md` を作成してください。
詳細は [環境構築メモ.md](./環境構築メモ.md) の「ステップ5: README.mdの作成」を参照してください。

---

## ステップ6: ビルドと起動

### 初回起動または完全にクリーンな状態から始める場合

```bash
# 既存のコンテナ・ボリュームを削除（既存環境がある場合）
docker compose down -v

# Dockerイメージをビルド（キャッシュなし）
docker compose build --no-cache

# コンテナを起動（バックグラウンド）
docker compose up -d

# ログを確認
docker compose logs -f
```

**重要**: gemを追加・削除した場合は必ず `-v` オプションでボリュームも削除してください。
bundle_cacheボリュームに古いGemfile.lockがキャッシュされていると、新しいgemが認識されません。

### 通常の起動（変更がない場合）

```bash
# Dockerイメージをビルド
docker compose build

# コンテナを起動（バックグラウンド）
docker compose up -d

# ログを確認
docker compose logs -f
```

---

## 動作確認

1. **Frontend**: ブラウザで http://localhost:5173 にアクセス
   - 「界回（KAIKAI）」と表示されればOK

2. **Backend**: ブラウザで http://localhost:3000 にアクセス
   - Railsのエラーページが表示されればOK（ルートが未定義のため）

3. **コンテナ状態確認**:
```bash
docker compose ps
# 両方とも "Up" になっていればOK
```

---

## よく使うコマンド

### コンテナ管理
```bash
# コンテナを起動
docker compose up -d

# コンテナを停止
docker compose down

# コンテナを再起動
docker compose restart

# コンテナの状態確認
docker compose ps

# ログをリアルタイム表示
docker compose logs -f

# 特定サービスのログのみ表示
docker compose logs -f backend
docker compose logs -f frontend
```

### コンテナ内に入る
```bash
# Railsコンテナに入る
docker compose exec backend bash

# Reactコンテナに入る
docker compose exec frontend sh
```

### Backend（Rails）操作
```bash
# Railsコンソール起動
docker compose exec backend rails console

# ルーティング確認
docker compose exec backend rails routes

# Gemを追加した後
docker compose exec backend bundle install
docker compose restart backend
```

### Frontend（React）操作
```bash
# パッケージを追加した後
docker compose exec frontend npm install
docker compose restart frontend

# ビルド
docker compose exec frontend npm run build
```

### トラブルシューティング
```bash
# 全コンテナとボリュームを削除して再構築
docker compose down -v
docker compose build --no-cache
docker compose up -d

# イメージを完全に削除して再作成
docker compose down --rmi all -v
docker compose build
docker compose up -d
```

---

## 技術スタック

- **Backend**: Ruby 3.3.6 + Rails 8.0.3 (API mode, **DBなし・最小構成**)
- **Frontend**: React 19 + TypeScript 5.9 + Vite 7.1 + TailwindCSS 4.1
- **Infrastructure**: Docker + Docker Compose

---

## 最小構成版の特徴

### ✅ 含まれているもの

#### コア機能
- Rails API（日付計算のみ）
- Puma Webサーバー
- Rack CORS（フロントエンド連携）
- Bootsnap（起動高速化）
- Debug gem（開発用）

#### デプロイ・本番環境ツール
- **Kamal**: Dockerコンテナのデプロイツール
- **Thruster**: HTTPキャッシング・圧縮（本番環境用）

#### 品質・セキュリティツール
- **Bundler Audit**: gemの既知の脆弱性チェック
- **Brakeman**: セキュリティ静的解析
- **Rubocop Rails Omakase**: Rubyコーディングスタイルチェック

#### フロントエンド高度機能
- **TailwindCSS v4カスタマイズ**: カスタムカラーパレット・フォント設定
- **デザインシステム**: 界藍/淡藤/白磁のカラーテーマ
- **タイポグラフィ**: Noto Sans JP（和文）+ Raleway（英文）

### ❌ 標準構成から除外したもの（最初から含まれていません）
- **データベース関連**: Active Record, SQLite3（`--skip-active-record`で除外）
- **ストレージ関連**: Active Storage, storage.yml（`--skip-active-storage`で除外）
- **キャッシュ/ジョブ**: Solid Cache/Queue/Cable（Gemfileから除外）
- **メール関連**: Action Mailer（`--api`モードで除外）

### 💡 メリット
- ✨ 起動が高速（DB不要）
- 📦 Dockerイメージサイズが比較的小さい
- 🎯 MVP要件に最適化
- 🔧 保守が簡単
- 🛡️ セキュリティ・品質チェックツール完備
- 🚀 本番環境へのデプロイ準備完了
- 🎨 統一されたデザインシステム

---

## カスタム設定

### カラーパレット
- **界藍**: `#4B5563` - メインカラー
- **淡藤**: `#A5B4FC` - アクセント
- **白磁**: `#F9FAFB` - ベース

### フォント
- **和文**: Noto Sans JP
- **英文**: Raleway

### アクセス先
- **Frontend**: http://localhost:5173
- **Backend API**: http://localhost:3000

---

## 次のステップ

環境構築が完了したら、以下の機能実装に進めます：

1. **APIエンドポイント実装** (`/api/v1/reservable_dates`)
2. **日付演算ロジック** (シフトサイクル計算)
3. **フロントエンドUI** (入力フォーム＋結果表示)

---

## よくあるエラーと対処法

### エラー: Rails起動時にActive Recordエラー
**原因**: `--skip-active-record`オプションを付け忘れた
**対処**: 
```bash
# config/application.rb から以下を削除
require "active_record/railtie"

# Gemfile から以下を削除
gem "sqlite3"

# 再ビルド
docker compose down -v
docker compose build --no-cache
docker compose up -d
```

### エラー: ポートが既に使用されている
**原因**: 別のプロセスがポート3000または5173を使用中
**対処**:
```bash
# ポート使用状況を確認
lsof -i :3000
lsof -i :5173

# プロセスを終了するか、docker-compose.ymlのポート番号を変更
```

### エラー: Railsが起動しない
**原因**: `tmp/pids/server.pid` が残っている
**対処**: `docker compose down` してから再起動

### フロントエンドで変更が反映されない
**原因**: ホットリロードが動作していない
**対処**:
```bash
docker compose restart frontend
```

---

## 重要な注意事項

### Rails 8.1について
現時点（2025年10月時点）では、Rails 8.1はまだリリースされていません。`rails new`コマンドで生成されるファイルには8.1の記述がありますが、以下を必ず修正してください：

1. `backend/Gemfile`: `gem "rails", "~> 8.0.0"`
2. `backend/config/application.rb`: `config.load_defaults 8.0`

### データベース不要について
本アプリはMVP段階では**日付計算のみ**を行うため、データベースは不要です。
将来的に以下を実装する場合はデータベースの追加を検討してください：

- ユーザー認証
- シフトデータの保存
- 予約履歴の管理
- 界プランAPI連携結果のキャッシュ

### Tailwind CSS v4について
Tailwind CSS v4では設定方法が大きく変わりました。以下の点に注意してください：

1. **必須パッケージ**: `@tailwindcss/postcss`が必要
2. **PostCSS設定**: `'@tailwindcss/postcss'`を使用（文字列で指定）
3. **CSS記述**: `@import "tailwindcss";`（`@tailwind`ディレクティブは使用しない）
4. **型定義**: `vite-env.d.ts`でCSSモジュールの型を宣言

### Tailwind CSS v4の高度な機能（本プロジェクトで実装済み）

本プロジェクトでは以下の高度なカスタマイズを実装しています：

#### 1. カスタムカラーパレット（`tailwind.config.js`）
```javascript
colors: {
  'kai-indigo': '#4B5563',    // 界藍 - メインカラー
  'kai-lavender': '#A5B4FC',  // 淡藤 - アクセント
  'kai-white': '#F9FAFB',     // 白磁 - ベース
}
```

使用例:
```html
<div className="bg-kai-white text-kai-indigo border-kai-lavender">
  界回
</div>
```

#### 2. カスタムフォントファミリー（`tailwind.config.js`）
```javascript
fontFamily: {
  'noto': ['"Noto Sans JP"', 'sans-serif'],    // 和文用
  'raleway': ['Raleway', 'sans-serif'],        // 英文用
}
```

使用例:
```html
<h1 className="font-noto">界回（KAIKAI）</h1>
<p className="font-raleway">Your shift, your journey</p>
```

#### 3. テーマ拡張機能
`theme.extend`を使用することで、デフォルトのTailwindテーマを保ちながら、
プロジェクト固有のデザインシステムを追加しています。

これにより、以下の利点があります：
- **一貫性**: 定義済みカラーを使用することで統一感のあるデザイン
- **保守性**: 色やフォントを一箇所で管理
- **タイプセーフ**: TypeScriptと組み合わせて型安全なスタイリング

---

## ライセンス

界回（KAIKAI） © 2025
